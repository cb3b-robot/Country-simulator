<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>World Happiness Conquest</title>
<style>
  :root { --bg:#0f1220; --card:#171a2b; --ink:#e8ecff; --muted:#aeb7d9; --accent:#7bd389; --bad:#ef6a6a; }
  html,body { margin:0; height:100%; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial; }
  header { padding:16px 20px; border-bottom:1px solid #24284a; display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
  header h1 { font-size:20px; margin:0; letter-spacing:.4px; }
  header .small { color:var(--muted); font-size:12px }
  #app { display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; padding:16px; }
  @media (max-width: 980px){ #app { grid-template-columns: 1fr; } }
  .panel { background:var(--card); border:1px solid #24284a; border-radius:12px; overflow:hidden; }
  .panel h2 { font-size:16px; margin:0 0 12px 0; }
  .pad { padding:16px; }
  #mapWrap { height: 64vh; min-height:420px; }
  #map svg { width:100%; height:100%; display:block; background:#87b7e9; }
  .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:8px; }
  select,button,input { background:#202443; color:var(--ink); border:1px solid #2c335d; padding:8px 10px; border-radius:8px; font:inherit; }
  button:hover { border-color:#3b447a; cursor:pointer; }
  button.primary { background:linear-gradient(180deg,#3f8cff,#2d57ff); border:none; }
  button.ghost { background:#1b1f39; }
  .pill { font-size:12px; padding:4px 8px; border-radius:999px; background:#1b1f39; border:1px solid #2c335d; color:var(--muted) }
  .statrow { display:flex; gap:10px; flex-wrap:wrap; }
  .stat { background:#1b1f39; border:1px solid #2c335d; border-radius:10px; padding:8px 10px; }
  .list { display:grid; gap:8px; max-height:240px; overflow:auto; }
  .row { display:flex; align-items:center; justify-content:space-between; gap:8px; background:#1b1f39; border:1px solid #2c335d; border-radius:10px; padding:8px 10px; }
  .row small { color:var(--muted); }
  .row input[type="range"]{ width:120px; }
  .legend { display:flex; align-items:center; gap:6px; }
  .swatch { width:16px; height:10px; border-radius:3px; border:1px solid #0006}
  .log { height:140px; overflow:auto; background:#101328; border:1px solid #24284a; border-radius:10px; padding:8px 10px; font-size:13px }
  .hint { color:var(--muted); font-size:12px; }
  .leader { font-weight:600; color:var(--accent) }
  .danger { color:var(--bad) }
  .center { display:flex; align-items:center; gap:8px; }
</style>
</head>
<body>
<header>
  <h1>World Happiness Conquest</h1>
  <span class="small">Goal: have the highest citizen satisfaction (population-weighted).</span>
</header>

<div id="app">
  <!-- MAP + GLOBAL CONTROLS -->
  <div class="panel">
    <div class="pad">
      <div class="controls">
        <div class="center">
          <label class="pill">Choose your country</label>
          <select id="countrySelect"></select>
          <button id="startBtn" class="primary">Start Game</button>
          <button id="resetViewBtn" class="ghost">Reset View</button>
        </div>
        <div class="legend">
          <span class="pill">Happiness</span>
          <div class="swatch" style="background:#b30000"></div><small>low</small>
          <div class="swatch" style="background:#ffd34d"></div><small>mid</small>
          <div class="swatch" style="background:#1a9850"></div><small>high</small>
        </div>
      </div>
    </div>
    <div id="mapWrap"><div id="map"></div></div>
    <div class="pad">
      <div class="statrow" id="leaderboard"></div>
      <p class="hint">Tip: Click any country on the map to inspect. Only your country shows action buttons.</p>
    </div>
  </div>

  <!-- COUNTRY PANEL -->
  <div class="panel">
    <div class="pad">
      <h2 id="panelTitle">No country selected</h2>
      <div id="countryStats" style="display:none">
        <div class="statrow">
          <div class="stat">Overall Happiness: <strong id="overallH"></strong></div>
          <div class="stat">Money: <strong id="money"></strong></div>
          <div class="stat">Military: <strong id="military"></strong></div>
          <div class="stat">Government: <strong id="government"></strong></div>
          <span class="pill" id="playerTag" style="display:none">You</span>
        </div>

        <!-- Player actions -->
        <div id="actions" style="margin-top:10px; display:none">
          <div class="controls">
            <button id="investBtn">Invest in selected region ($200 â†’ +6 happiness)</button>
            <button id="developAllBtn">Develop nationwide ($400 â†’ +2 each region)</button>
            <button id="buyMilBtn">Buy military ($50/unit â†’ -1 happiness per 3 units)</button>
            <select id="govSelect">
              <option value="">Change governmentâ€¦</option>
              <option value="democracy">Democracy (+5 all regions)</option>
              <option value="socialism">Socialism (+3 all regions)</option>
              <option value="communism">Communism (+1 all regions)</option>
            </select>
            <button id="saveBtn" class="ghost">ðŸ’¾ Save</button>
            <button id="loadBtn" class="ghost">ðŸ“‚ Load</button>
          </div>
          <p class="hint">Select a region below to target your investment.</p>
        </div>

        <!-- Regions list -->
        <h3>Regions</h3>
        <div class="list" id="regions"></div>

        <h3>World Log</h3>
        <div class="log" id="log"></div>
      </div>
    </div>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3/dist/d3-scale-chromatic.min.js"></script>

<script>
/* =========================
   Helpers & deterministic RNG
   ========================= */
const STORAGE_KEY = 'whc_v1_save';

const fmtMoney = (v)=>'$'+Math.round(v).toLocaleString();
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

function xorshift(seed) { let x = seed >>> 0; return function(){ x ^= x << 13; x ^= x >>> 17; x ^= x << 5; return ((x>>>0)/4294967296); } }
function pickWeightedDirichlet(rand, n) {
  const arr = Array.from({length:n}, () => -Math.log(1 - rand()));
  const sum = arr.reduce((a,b)=>a+b,0);
  return arr.map(v=>v/sum);
}

/* =========================
   Game state
   ========================= */
const state = {
  countries: new Map(), // id(string)-> country obj
  features: [],
  landFeature: null,
  playerId: null,
  selectedId: null,
  tickMs: 6000,
  running: false,
};

function overallHappiness(c){
  const tot = c.regions.reduce((s,r)=>s+r.population,0);
  const sum = c.regions.reduce((s,r)=>s+r.happiness*r.population,0);
  return Math.round(sum / Math.max(1,tot));
}
function colorForH(h){ return d3.interpolateRdYlGn(clamp(h/100,0,1)); }

/* =========================
   Map setup
   ========================= */
const mapEl = d3.select('#map');
let W=0,H=0, svg, g, projection, path;
let oceanPath, landPath;

function sizeMap(){
  W = mapEl.node().getBoundingClientRect().width || 800;
  H = document.getElementById('mapWrap').getBoundingClientRect().height || 500;

  if(!svg){
    svg = mapEl.append('svg');
    g = svg.append('g');            // everything (ocean, land, countries) inside g so zoom works

    oceanPath = g.append('path')    // ocean INSIDE g
      .attr('class','ocean')
      .attr('fill','#87b7e9')
      .attr('stroke','none');

    landPath = g.append('path')     // base land under countries
      .attr('class','land')
      .attr('fill','#dfe8c5')
      .attr('stroke','#1b1f39')
      .attr('stroke-width',0.3);
  }

  svg.attr('viewBox', `0 0 ${W} ${H}`);
  projection = d3.geoNaturalEarth1().fitSize([W, H], {type:"Sphere"});
  path = d3.geoPath(projection);

  oceanPath.attr('d', path({type:'Sphere'}));
  if(state.landFeature) landPath.attr('d', path(state.landFeature));

  redrawCountries();
}
window.addEventListener('resize', sizeMap);

/* ==========================================
   Load world: topology + robust name mapping
   ========================================== */
async function loadNames() {
  const urls = [
    'https://cdn.jsdelivr.net/npm/world-atlas@2/country-names.tsv',
    'https://unpkg.com/world-atlas@2/country-names.tsv'
  ];
  for (const u of urls) {
    try {
      const r = await fetch(u, {cache:'force-cache'});
      if (!r.ok) continue;
      const tsv = await r.text();
      const rows = d3.tsvParse(tsv);
      const map = new Map();
      rows.forEach(row=>{
        const idNum = +row.id;
        if(!isNaN(idNum)) map.set(idNum, row.name);
      });
      if(map.size) return map;
    } catch(_){}
  }
  return new Map();
}

async function initWorld(){
  sizeMap();

  const [topology, landTopo, nameMap] = await Promise.all([
    fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json').then(r=>r.json()),
    fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/land-110m.json').then(r=>r.json()),
    loadNames()
  ]);

  state.features = topojson.feature(topology, topology.objects.countries).features.map(f=>{
    const idNum = +f.id;
    const name = nameMap.get(idNum) || f.properties?.name || `Country ${idNum}`;
    const cid = String(idNum);
    f.properties = { ...f.properties, name, cid };
    return f;
  });

  state.landFeature = topojson.feature(landTopo, landTopo.objects.land);

  // init countries
  state.countries.clear();
  for(const f of state.features){
    const id = f.properties.cid;
    const name = f.properties.name;
    const rand = xorshift(+id * 2654435761);
    const regionsCount = 3 + Math.floor(rand()*6); // 3..8
    const weights = pickWeightedDirichlet(rand, regionsCount);
    const totalPop = 2_000_000 + Math.floor(rand()*60_000_000); // fictional baseline
    const baseH = 40 + Math.floor(rand()*30); // 40..70
    const regions = weights.map((w,i)=>({
      name: `${name} Region ${i+1}`,
      population: Math.max(50_000, Math.round(totalPop*w)),
      happiness: clamp(baseH + Math.floor(rand()*20-10), 10, 90)
    }));
    state.countries.set(id, {
      id, name,
      money: 1000 + Math.floor(rand()*1500),
      military: 30 + Math.floor(rand()*70),
      government: 'democracy',
      regions,
      isAI: true
    });
  }

  populateSelector();
  redrawCountries();
  updateLeaderboard();
  log(`World ready: ${state.countries.size} countries.`);
}

function redrawCountries(){
  if(!state.features.length || !path) return;

  // keep ocean/land synced to projection
  oceanPath.attr('d', path({type:'Sphere'}));
  if(state.landFeature) landPath.attr('d', path(state.landFeature));

  const sel = g.selectAll('path.country').data(state.features, d=>d.properties.cid);

  const enter = sel.enter().append('path')
    .attr('class','country')
    .attr('d', path)
    .attr('stroke','#1b1f39')
    .attr('stroke-width',0.5)
    .on('click', (_e,d)=> selectCountry(d.properties.cid, true));

  g.selectAll('path.country').selectAll('title')
    .data(d => [d]).join('title').text(d => d.properties.name);

  sel.merge(enter).attr('fill', d => {
    const c = state.countries.get(d.properties.cid);
    return colorForH(overallHappiness(c || {regions:[]}));
  });

  sel.exit().remove();
}

function zoomToFeature(f){
  const b = path.bounds(f);
  const dx = b[1][0]-b[0][0], dy=b[1][1]-b[0][1];
  const x = (b[0][0]+b[1][0])/2, y=(b[0][1]+b[1][1])/2;
  const scale = Math.max(1, Math.min(8, 0.9/Math.max(dx/W, dy/H)));
  const translate = [W/2 - scale*x, H/2 - scale*y];
  g.transition().duration(700).attr('transform', `translate(${translate}) scale(${scale})`);
}
document.getElementById('resetViewBtn').onclick = ()=> g.transition().duration(600).attr('transform','translate(0,0) scale(1)');

/* =========================
   UI: selector + panel
   ========================= */
const countrySelect = document.getElementById('countrySelect');

function populateSelector(){
  countrySelect.innerHTML = '';
  const arr = [...state.countries.values()].sort((a,b)=> a.name.localeCompare(b.name));
  for(const c of arr){
    const opt = document.createElement('option');
    opt.value = String(c.id);
    opt.textContent = c.name;
    countrySelect.appendChild(opt);
  }
}

function selectCountry(id, zoom=false){
  state.selectedId = String(id);
  const f = state.features.find(fe => fe.properties.cid === String(id));
  if (zoom && f) zoomToFeature(f);
  renderPanel();
}

document.getElementById('startBtn').onclick = ()=>{
  const id = countrySelect.value || [...state.countries.keys()][0];
  state.playerId = String(id);
  state.countries.get(state.playerId).isAI = false;
  selectCountry(id, true);
  state.running = true;
  log(`You are playing as ${state.countries.get(state.playerId).name}. Maximize happiness!`);
  tick();
  renderPanel();
};

function renderPanel(){
  const panel = document.getElementById('countryStats');
  const title = document.getElementById('panelTitle');
  if(!state.selectedId){ title.textContent = 'No country selected'; panel.style.display='none'; return; }
  const c = state.countries.get(state.selectedId);
  panel.style.display = 'block';
  title.textContent = c.name;
  document.getElementById('overallH').textContent = overallHappiness(c);
  document.getElementById('money').textContent = fmtMoney(c.money);
  document.getElementById('military').textContent = Math.round(c.military);
  document.getElementById('government').textContent = c.government;
  document.getElementById('playerTag').style.display = (String(c.id)===String(state.playerId)) ? '' : 'none';
  document.getElementById('actions').style.display = (String(c.id)===String(state.playerId)) ? '' : 'none';
  // regions
  const list = document.getElementById('regions');
  list.innerHTML='';
  c.regions.forEach((r,idx)=>{
    const row = document.createElement('div'); row.className='row';
    row.innerHTML = `
      <div style="flex:1 1 auto">
        <strong>${r.name}</strong><br/>
        <small>Pop: ${r.population.toLocaleString()} â€¢ Happiness: <span id="rH${idx}">${Math.round(r.happiness)}</span></small>
      </div>
      <input type="radio" name="regionPick" value="${idx}" ${idx===0?'checked':''} />
      <input type="range" min="0" max="100" value="${Math.round(r.happiness)}" disabled />
    `;
    list.appendChild(row);
  });
  updateLeaderboard();
  redrawCountries();
}

/* =========================
   Player actions
   ========================= */
const getPlayer = ()=> state.countries.get(state.playerId);

document.getElementById('investBtn').onclick = ()=>{
  const me = getPlayer(); if(!me) return;
  const picked = document.querySelector('input[name="regionPick"]:checked');
  const idx = picked ? +picked.value : 0;
  if(me.money < 200){ log('<span class="danger">Not enough money to invest.</span>'); return; }
  me.money -= 200;
  me.regions[idx].happiness = clamp(me.regions[idx].happiness + 6, 0, 100);
  log(`Invested in <b>${me.regions[idx].name}</b>: +6 happiness.`);
  renderPanel();
};

document.getElementById('developAllBtn').onclick = ()=>{
  const me = getPlayer(); if(!me) return;
  if(me.money < 400){ log('<span class="danger">Not enough money to develop nationwide.</span>'); return; }
  me.money -= 400;
  me.regions.forEach(r=> r.happiness = clamp(r.happiness + 2, 0, 100));
  log('Nationwide development: +2 happiness in every region.');
  renderPanel();
};

document.getElementById('buyMilBtn').onclick = ()=>{
  const me = getPlayer(); if(!me) return;
  const units = +prompt('How many units? ($50 each)', '5') || 0;
  const cost = units*50;
  if(cost<=0){ return; }
  if(me.money < cost){ log('<span class="danger">Not enough money for military.</span>'); return; }
  me.money -= cost; me.military += units;
  const penalty = Math.floor(units/3);
  me.regions.forEach(r=> r.happiness = clamp(r.happiness - penalty, 0, 100));
  log(`Bought ${units} units. National happiness -${penalty}.`);
  renderPanel();
};

document.getElementById('govSelect').onchange = (e)=>{
  const me = getPlayer(); if(!me) return;
  const g = e.target.value; if(!g) return;
  me.government = g;
  const boost = g==='democracy'?5 : g==='socialism'?3 : 1;
  me.regions.forEach(r=> r.happiness = clamp(r.happiness + boost, 0, 100));
  log(`Government changed to <b>${g}</b>. +${boost} happiness in all regions.`);
  e.target.value='';
  renderPanel();
};

/* =========================
   AI loop
   ========================= */
function aiTurnOne(c){
  const worst = [...c.regions].sort((a,b)=> a.happiness - b.happiness)[0];
  if(c.money >= 200){
    c.money -= 200;
    worst.happiness = clamp(worst.happiness + 5, 0, 100);
    return `${c.name} invested in ${worst.name} (+5).`;
  }
  if(Math.random()<0.125){
    const opts=['democracy','socialism','communism'];
    const g = opts[Math.floor(Math.random()*opts.length)];
    c.government = g;
    const boost = g==='democracy'?4 : g==='socialism'?3 : 1;
    c.regions.forEach(r=> r.happiness = clamp(r.happiness + boost, 0, 100));
    return `${c.name} changed government to ${g} (+${boost} all).`;
  }
  if(c.money >= 150 && Math.random()<0.166){
    c.money -= 150; c.military += 3;
    c.regions.forEach(r=> r.happiness = clamp(r.happiness - 1, 0, 100));
    return `${c.name} bought military (-1 national happiness).`;
  }
  c.money += 60;
  c.regions.forEach(r=>{ r.happiness += (68 - r.happiness)*0.02; });
  return `${c.name} maintained stability.`;
}

function tick(){
  if(!state.running) return;
  for(const c of state.countries.values()){ c.money += 80; }
  for(const c of state.countries.values()){
    if(String(c.id)!==String(state.playerId)){
      const msg = aiTurnOne(c);
      if(Math.random()<0.3) log(msg);
    }
  }
  redrawCountries();
  updateLeaderboard();
  renderPanel();
  setTimeout(tick, state.tickMs);
}

/* =========================
   Save / Load
   ========================= */
document.getElementById('saveBtn').onclick = ()=>{
  const payload = {
    version: 1,
    playerId: state.playerId,
    data: [...state.countries.entries()].map(([id,c])=>[String(id),{
      id:String(c.id), name:c.name, money:c.money, military:c.military, government:c.government, isAI:c.isAI,
      regions: c.regions.map(r=>({name:r.name, population:r.population, happiness:r.happiness}))
    }])
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  log('Game saved.');
};

document.getElementById('loadBtn').onclick = ()=>{
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ log('<span class="danger">No saved game found.</span>'); return; }
  try{
    const payload = JSON.parse(raw);
    state.playerId = payload.playerId ? String(payload.playerId) : null;
    state.countries.clear();
    for(const [id,c] of payload.data){ state.countries.set(String(id), c); }
    populateSelector();
    state.running = true;
    const selectId = state.playerId || [...state.countries.keys()][0];
    selectCountry(selectId, true);
    updateLeaderboard();
    log('Game loaded.');
  }catch(e){ console.error(e); log('<span class="danger">Failed to load save.</span>'); }
};

/* =========================
   Leaderboard + log
   ========================= */
function updateLeaderboard(){
  const holder = document.getElementById('leaderboard');
  const arr = [...state.countries.values()].map(c=>({ id:c.id, name:c.name, h:overallHappiness(c) }));
  arr.sort((a,b)=> b.h - a.h);
  holder.innerHTML = arr.slice(0,6).map((c,i)=>`
    <div class="stat">${i+1}. <strong>${c.name}</strong> â€” <span class="leader">${c.h}</span>
      ${String(c.id)===String(state.playerId)?' <span class="pill">You</span>':''}
    </div>`).join('');
}

function log(html){
  const el = document.getElementById('log');
  const p = document.createElement('div');
  p.innerHTML = `<span class="muted">${new Date().toLocaleTimeString()}</span> ${html}`;
  el.appendChild(p);
  el.scrollTop = el.scrollHeight;
}

/* Kick off */
initWorld().catch(err=>{
  console.error(err);
  log('<span class="danger">Failed to load world map. Check your network/CSP.</span>');
});
</script>
</body>
</html>
