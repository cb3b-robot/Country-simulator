<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>World Happiness Conquest ‚Äî Full Build</title>
<style>
  :root { --bg:#0f1220; --card:#171a2b; --ink:#e8ecff; --muted:#aeb7d9; --accent:#7bd389; --bad:#ef6a6a; --gold:#ffd34d; }
  html,body { margin:0; height:100%; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial; }
  header { padding:16px 20px; border-bottom:1px solid #24284a; display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
  header h1 { font-size:20px; margin:0; letter-spacing:.4px; }
  header .small { color:var(--muted); font-size:12px }
  #app { display:grid; grid-template-columns: 1.25fr .75fr; gap:16px; padding:16px; }
  @media (max-width: 1080px){ #app { grid-template-columns: 1fr; } }
  .panel { background:var(--card); border:1px solid #24284a; border-radius:12px; overflow:hidden; }
  .panel h2, .panel h3 { margin:0 0 12px 0; font-size:16px; }
  .pad { padding:16px; }
  #mapWrap { height: 62vh; min-height:420px; }
  /* Map polish */
  #map svg { width:100%; height:100%; display:block; background:none; } /* gradient sphere handles ocean */
  .country { transition: fill .15s ease, stroke-width .15s ease, opacity .15s ease; }
  .country:hover { stroke-width: 0.9 !important; filter: drop-shadow(0 0 2px #0006); }
  .graticule { stroke:#ffffff15; stroke-width:0.6; fill:none; pointer-events:none; }
  .sphere-outline { stroke:#0b1025; stroke-width:1.2; fill:none; opacity:.7; pointer-events:none; }
  .borders { stroke:#0b1025; stroke-width:0.6; fill:none; opacity:.55; pointer-events:none; }
  .coastline { stroke:#0b1025; stroke-width:0.7; fill:#dfe8c5; opacity:.95; pointer-events:none; }
  .lakes { fill:#b7d0f3; stroke:#0b1025; stroke-width:0.4; opacity:.9; }
  /* in-country region overlay */
  .region-cell { stroke:#101328; stroke-width:.3; cursor:pointer; }
  .region-cell:hover { stroke:#fff; stroke-width:1; }
  .region-selected { stroke:var(--gold) !important; stroke-width:2 !important; }
  /* crisp borders between regions (two-layer for contrast) */
  .region-borders-back { stroke:#0b1025; stroke-width:2.2; fill:none; opacity:.55; pointer-events:none; }
  .region-borders-front { stroke:#ffffff; stroke-width:0.8; fill:none; opacity:.9; pointer-events:none; }
  /* alliance lines */
  .ally-line { stroke:#ffd34d; stroke-width:1.6; stroke-dasharray:4 4; opacity:.9; pointer-events:none; }
  /* buildings */
  .building { cursor:grab; pointer-events:all; }
  .building:active { cursor:grabbing; }
  .house .roof { fill:#e86c5b; } .house .wall { fill:#f1d8c9; }
  .factory .body { fill:#b8c1d1; } .factory .chimney { fill:#8d96a5; }
  .hospital .cross { fill:#ef6a6a; } .hospital .body { fill:#e3f2ff; }
  .school .body { fill:#ffe2b6; } .school .roof { fill:#c77d3c; }
  .barracks .body { fill:#8aa17a; } .barracks .roof { fill:#5e6d56; }
  /* ui controls */
  .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:8px; }
  select,button,input { background:#202443; color:var(--ink); border:1px solid #2c335d; padding:8px 10px; border-radius:8px; font:inherit; }
  button:hover { border-color:#3b447a; cursor:pointer; }
  button.primary { background:linear-gradient(180deg,#3f8cff,#2d57ff); border:none; }
  button.ghost { background:#1b1f39; }
  .pill { font-size:12px; padding:4px 8px; border-radius:999px; background:#1b1f39; border:1px solid #2c335d; color:var(--muted) }
  .statrow { display:flex; gap:10px; flex-wrap:wrap; }
  .stat { background:#1b1f39; border:1px solid #2c335d; border-radius:10px; padding:8px 10px; }
  .list { display:grid; gap:8px; max-height:220px; overflow:auto; }
  .row { display:flex; align-items:center; justify-content:space-between; gap:8px; background:#1b1f39; border:1px solid #2c335d; border-radius:10px; padding:8px 10px; }
  .row small { color:var(--muted); }
  .row input[type="range"]{ width:140px; }
  .log { height:180px; overflow:auto; background:#101328; border:1px solid #24284a; border-radius:10px; padding:8px 10px; font-size:13px }
  .hint { color:var(--muted); font-size:12px; }
  .leader { font-weight:600; color:var(--accent) }
  .danger { color:var(--bad) }
  .center { display:flex; align-items:center; gap:8px; }
  .banner { background:#1b1f39; border:1px solid #3b447a; border-left:4px solid var(--gold); padding:8px 10px; border-radius:8px; margin:8px 0; }
  .subgrid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  @media (max-width: 560px){ .subgrid { grid-template-columns: 1fr; } }
  /* tabs */
  .tabs { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px; }
  .tabbtn { background:#1b1f39; border:1px solid #2c335d; color:var(--ink); padding:8px 10px; border-radius:10px; cursor:pointer; }
  .tabbtn.active { border-color:#ffd34d; box-shadow:0 0 0 1px #ffd34d inset; }
  .tabpane { display:none; }
  .tabpane.active { display:block; }
</style>
</head>
<body>
<header>
  <h1>World Happiness Conquest ‚Äî Full Build</h1>
  <span class="small">Win by highest population-weighted happiness. Tabs, hotkeys, polished map, conscription, research, budget, gifts, buildings, wars & more.</span>
</header>

<div id="app">
  <!-- MAP + GLOBAL CONTROLS -->
  <div class="panel">
    <div class="pad">
      <div class="controls" style="gap:12px">
        <div class="center" style="gap:8px">
          <label class="pill">Choose</label>
          <select id="countrySelect"></select>
          <button id="startBtn" class="primary">Start</button>
          <button id="resetViewBtn" class="ghost">Reset View</button>
        </div>
        <div class="center" style="gap:8px">
          <label class="pill">Color by</label>
          <select id="colorMode">
            <option value="happiness">Happiness</option>
            <option value="money">Money</option>
            <option value="alliances">Alliances</option>
          </select>
          <label class="pill" style="display:flex;gap:6px;align-items:center">
            <input type="checkbox" id="showAllyLines"> Alliance lines
          </label>
        </div>
        <div class="center" style="gap:8px">
          <label class="pill">Save slot</label>
          <select id="saveSlot"><option>1</option><option>2</option><option>3</option></select>
          <button id="saveBtn" class="ghost">üíæ Save</button>
          <button id="loadBtn" class="ghost">üìÇ Load</button>
        </div>
      </div>
      <div id="eventBanner" class="banner" style="display:none;"></div>
    </div>

    <div id="mapWrap"><div id="map"></div></div>

    <div class="pad">
      <div class="statrow" id="leaderboard"></div>
      <p class="hint">Click a country to zoom and reveal its regions. Click a region to select it. Buildings are draggable when ‚ÄúMove buildings‚Äù is on. Hotkeys: 1‚Äì8 tabs, ‚Üê/‚Üí cycle.</p>
    </div>
  </div>

  <!-- RIGHT PANEL (TABS) -->
  <div class="panel">
    <div class="pad">
      <h2 id="panelTitle">No country selected</h2>
      <div id="countryStats" style="display:none">
        <!-- Header stats -->
        <div class="statrow">
          <div class="stat">Overall Happiness: <strong id="overallH"></strong></div>
          <div class="stat">Money: <strong id="money"></strong></div>
          <div class="stat">Military (pool): <strong id="military"></strong></div>
          <div class="stat">Government: <strong id="government"></strong></div>
          <span class="pill" id="playerTag" style="display:none">You</span>
        </div>

        <!-- Tabs -->
        <div class="tabs" id="tabs">
          <button class="tabbtn active" data-tab="tab-overview"   data-hotkey="1">1¬∑ Overview</button>
          <button class="tabbtn"          data-tab="tab-regions"   data-hotkey="2">2¬∑ Regions</button>
          <button class="tabbtn"          data-tab="tab-projects"  data-hotkey="3">3¬∑ Projects/Buildings</button>
          <button class="tabbtn"          data-tab="tab-economy"   data-hotkey="4">4¬∑ Economy/Budget</button>
          <button class="tabbtn"          data-tab="tab-research"  data-hotkey="5">5¬∑ Research</button>
          <button class="tabbtn"          data-tab="tab-diplomacy" data-hotkey="6">6¬∑ Diplomacy/Trade</button>
          <button class="tabbtn"          data-tab="tab-military"  data-hotkey="7">7¬∑ Military/War</button>
          <button class="tabbtn"          data-tab="tab-log"       data-hotkey="8">8¬∑ Events/Log</button>
        </div>

        <!-- TAB: Overview -->
        <div class="tabpane active" id="tab-overview">
          <div class="row">
            <div>Goal: Highest population-weighted happiness. Use tabs to manage your country.</div>
          </div>
          <div class="controls">
            <select id="govSelect">
              <option value="">Change government‚Ä¶</option>
              <option value="democracy">Democracy (+5 all regions)</option>
              <option value="socialism">Socialism (+3 all regions)</option>
              <option value="communism">Communism (+1 all regions)</option>
            </select>
            <button id="developAllBtn">Develop nationwide ($400 ‚Üí +2 each region)</button>
          </div>
          <div class="statrow" id="marketPrices"></div>
          <div class="list" id="resourceTotals"></div>
        </div>

        <!-- TAB: Regions -->
        <div class="tabpane" id="tab-regions">
          <h3>Regions</h3>
          <div class="list" id="regions"></div>
        </div>

        <!-- TAB: Projects & Buildings -->
        <div class="tabpane" id="tab-projects">
          <div class="subgrid">
            <div>
              <h3>Projects</h3>
              <div class="row">
                <select id="projectSelect">
                  <option value="infra">Infrastructure (4 turns ‚Ä¢ +2 happiness/turn)</option>
                  <option value="upgrade">Resource Upgrade (3 turns ‚Ä¢ +20% prod)</option>
                  <option value="culture">Cultural Program (2 turns ‚Ä¢ +8 happiness)</option>
                </select>
                <button id="startProjectBtn">Start ($250)</button>
              </div>
              <div class="list" id="projectList"></div>
            </div>
            <div>
              <h3>Buildings</h3>
              <div class="row">
                <select id="buildSelect">
                  <option value="house">House ($200) ‚Äî +pop growth</option>
                  <option value="factory">Factory ($400) ‚Äî +money (minor -happy)</option>
                  <option value="hospital">Hospital ($450) ‚Äî +happiness</option>
                  <option value="school">School ($350) ‚Äî +production</option>
                  <option value="barracks">Barracks ($300) ‚Äî +troop capacity</option>
                </select>
                <button id="placeBuildingBtn">Place on map</button>
              </div>
              <label class="pill" style="display:flex;gap:6px;align-items:center">
                <input type="checkbox" id="moveBuildingsToggle"> Move buildings
              </label>
              <p class="hint">Click inside your zoomed country to place; toggle ‚ÄúMove buildings‚Äù to drag.</p>
            </div>
          </div>
        </div>

        <!-- TAB: Economy & Budget -->
        <div class="tabpane" id="tab-economy">
          <h3>Budget & Policies</h3>
          <div class="row">
            <div><strong>Budget</strong><br/><small>Allocate next-turn effects</small></div>
            <div>
              Welfare <input id="budgetWelfare" type="range" min="0" max="100" value="50"> Military <span id="budgetWelfareVal">50</span>%
            </div>
          </div>
          <div class="row">
            <div><strong>Conscription</strong><br/><small>Troops vs Happiness</small></div>
            <div>
              Low <input id="conscription" type="range" min="0" max="2" value="1"> High
              <span id="conscriptionLabel">Medium</span>
            </div>
          </div>
          <div class="row">
            <button id="applyBudgetBtn">Apply Policy Changes</button>
            <span class="hint">Budget & conscription influence income, troop growth and happiness each tick.</span>
          </div>
        </div>

        <!-- TAB: Research -->
        <div class="tabpane" id="tab-research">
          <h3>Research (one-time unlocks)</h3>
          <div class="list" id="researchList"></div>
        </div>

        <!-- TAB: Diplomacy & Trade -->
        <div class="tabpane" id="tab-diplomacy">
          <div class="row">
            <select id="partnerSelect"></select>
            <select id="tradeResource">
              <option value="Food">Food</option><option value="Oil">Oil</option><option value="Tech">Tech</option><option value="Tourism">Tourism</option>
            </select>
            <input id="tradeAmount" type="number" min="1" value="10" style="width:80px"/>
          </div>
          <div class="controls">
            <button id="sellBtn">Sell</button>
            <button id="buyBtn">Buy</button>
            <button id="allyBtn">Offer Alliance</button>
            <button id="giftMoneyBtn">Send Gift ($500)</button>
            <button id="giftResBtn">Send 20 Resource</button>
          </div>
          <p class="hint" id="relationHint"></p>
        </div>

        <!-- TAB: Military & War -->
        <div class="tabpane" id="tab-military">
          <div class="controls">
            <input id="troopDelta" type="number" value="5" style="width:80px"/>
            <button id="assignTroopsBtn">Assign to selected</button>
            <button id="removeTroopsBtn">Remove from selected</button>
          </div>
          <div class="controls">
            <button id="declareWarBtn" class="danger">Declare War</button>
            <button id="attackBtn">Attack Region</button>
            <button id="peaceBtn">Make Peace</button>
          </div>
        </div>

        <!-- TAB: Events & Log -->
        <div class="tabpane" id="tab-log">
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3/dist/d3-scale-chromatic.min.js"></script>

<script>
/* =========================
   Basics & helpers
   ========================= */
const STORAGE_KEY_BASE = 'whc_tabs_slot_';
const RESOURCES = ['Food','Oil','Tech','Tourism'];
const RESEARCH = [
  {id:'green', name:'Green Energy', desc:'+5 happiness nationwide', cost:600, apply:(c)=> c.regions.forEach(r=>r.happiness=Math.min(100,r.happiness+5))},
  {id:'automation', name:'Automation', desc:'+1 production all regions', cost:500, apply:(c)=> c.regions.forEach(r=>r.production+=1)},
  {id:'logistics', name:'Logistics', desc:'+10% market sale value', cost:500, apply:(c)=> c.researchBuffs.saleBonus=0.1},
  {id:'civics', name:'Civics Program', desc:'+2 happiness/turn for 3 turns', cost:450, apply:(c)=> c.researchBuffs.happyOverTime=3}
];

const fmtMoney = (v)=>'$'+Math.round(v).toLocaleString();
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
function keyPair(a,b){ return String(a)<String(b) ? `${a}|${b}` : `${b}|${a}`; }
function xorshift(seed) { let x = seed >>> 0; return function(){ x ^= x << 13; x ^= x >>> 17; x ^= x << 5; return ((x>>>0)/4294967296); } }
function pickWeightedDirichlet(rand, n) {
  const arr = Array.from({length:n}, () => -Math.log(1 - rand()));
  const sum = arr.reduce((a,b)=>a+b,0);
  return arr.map(v=>v/sum);
}

/* =========================
   Game state
   ========================= */
const state = {
  countries: new Map(),
  relations: new Map(), // "A|B" -> -100..100
  alliances: new Set(), // "A|B"
  wars: new Set(),      // "A|B"
  features: [],
  landFeature: null,
  lakesFeature: null,
  bordersMesh: null,
  playerId: null,
  selectedId: null,
  selectedRegionIdx: 0,
  turn: 0,
  tickMs: 6000,
  running: false,
  market: { Food: 4, Oil: 9, Tech: 12, Tourism: 7 },

  colorMode: 'happiness',
  showAllyLines: false,

  regionOverlayG: null,
  buildingsG: null,
  placingBuilding: null,
  movingBuildings: false,

  // conquered region overlays
  annexOverlays: [] // [{ownerId, ownerName, polygon:[[x,y],...]}]
};

/* =========================
   Map & rendering
   ========================= */
const mapEl = d3.select('#map');
let W=0,H=0, svg, g, projection, path;
let oceanPath, sphereOutlinePath, graticulePath, coastlinePath, landPath, lakesPath, bordersPath, allyLinesG;

// Graticule
const graticule = d3.geoGraticule().step([20, 20]); // gentle 20¬∞ grid

function sizeMap(){
  W = mapEl.node().getBoundingClientRect().width || 800;
  H = document.getElementById('mapWrap').getBoundingClientRect().height || 500;

  if(!svg){
    svg = mapEl.append('svg');
    const defs = svg.append('defs');

    // Ocean radial gradient
    const grad = defs.append('radialGradient').attr('id','oceanGrad').attr('cx','50%').attr('cy','45%');
    grad.append('stop').attr('offset','0%').attr('stop-color','#9cc4f2');
    grad.append('stop').attr('offset','60%').attr('stop-color','#7bb0e9');
    grad.append('stop').attr('offset','100%').attr('stop-color','#5d92cb');

    // Subtle noise filter for land
    const noise = defs.append('filter').attr('id','subtleNoise').attr('x','-20%').attr('y','-20%').attr('width','140%').attr('height','140%');
    noise.append('feTurbulence').attr('type','fractalNoise').attr('baseFrequency','0.8').attr('numOctaves','1').attr('result','N');
    noise.append('feColorMatrix').attr('type','matrix')
         .attr('values','0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 .025 0');
    noise.append('feBlend').attr('in','SourceGraphic').attr('in2','N').attr('mode','normal');

    // Soft shadow filter for globe group
    const sh = defs.append('filter').attr('id','softShadow').attr('x','-30%').attr('y','-30%').attr('width','160%').attr('height','160%');
    sh.append('feDropShadow').attr('dx','0').attr('dy','1.5').attr('stdDeviation','1.2').attr('flood-color','#000').attr('flood-opacity','.25');

    g = svg.append('g').attr('filter','url(#softShadow)');

    // Layer order
    oceanPath = g.append('path').attr('class','ocean').attr('fill','url(#oceanGrad)').attr('stroke','none');
    graticulePath = g.append('path').attr('class','graticule');
    sphereOutlinePath = g.append('path').attr('class','sphere-outline');
    coastlinePath = g.append('path').attr('class','coastline');
    landPath  = g.append('path').attr('class','land').attr('filter','url(#subtleNoise)');
    lakesPath = g.append('path').attr('class','lakes');
    bordersPath = g.append('path').attr('class','borders');
    allyLinesG = g.append('g').attr('class','ally-lines');
  }

  svg.attr('viewBox', `0 0 ${W} ${H}`);
  projection = d3.geoNaturalEarth1().fitExtent([[8,8],[W-8,H-8]], {type:"Sphere"});
  path = d3.geoPath(projection);

  // Static layers
  oceanPath.attr('d', path({type:'Sphere'}));
  graticulePath.attr('d', path(graticule())).attr('vector-effect','non-scaling-stroke');
  sphereOutlinePath.attr('d', path({type:'Sphere'}));
  if(state.landFeature) coastlinePath.attr('d', path(state.landFeature));
  if(state.landFeature) landPath.attr('d', path(state.landFeature));
  if(state.lakesFeature) lakesPath.attr('d', path(state.lakesFeature));
  if(state.bordersMesh) bordersPath.attr('d', path(state.bordersMesh)).attr('vector-effect','non-scaling-stroke');

  redrawCountries();
  drawAllianceLines();
  drawAnnexOverlays();
  if(state.selectedId){ buildRegionOverlay(state.selectedId); drawBuildings(); }
}
window.addEventListener('resize', sizeMap);

function countryCentroid(id){
  const f = state.features.find(fe=>fe.properties.cid===String(id));
  return f ? path.centroid(f) : [0,0];
}
function overallHappiness(c){
  const tot = c.regions.reduce((s,r)=>s+r.population,0);
  const sum = c.regions.reduce((s,r)=>s+r.happiness*r.population,0);
  return Math.round(sum / Math.max(1,tot));
}
function colorForH(h){ return d3.interpolateRdYlGn(clamp(h/100,0,1)); }
function colorForMoney(m, min, max){ const t = (m-min)/Math.max(1,(max-min)); return d3.interpolateBlues(clamp(t,0,1)); }
function allianceGroups(){
  const ids=[...state.countries.keys()];
  const gmap = new Map(); ids.forEach(id=>gmap.set(id,-1));
  let gid=0; const adj = new Map(); ids.forEach(id=>adj.set(id,[]));
  for(const k of state.alliances){ const [a,b]=k.split('|'); adj.get(a).push(b); adj.get(b).push(a); }
  for(const id of ids){
    if(gmap.get(id)!==-1) continue;
    const q=[id]; gmap.set(id,gid);
    while(q.length){ const u=q.shift(); for(const v of adj.get(u)){ if(gmap.get(v)===-1){ gmap.set(v,gid); q.push(v);} } }
    gid++;
  }
  return {gmap,gid};
}
function colorForAlliance(id){
  const {gmap} = allianceGroups();
  const scheme = d3.schemeSet3;
  const group = gmap.get(String(id)) ?? 0;
  return scheme[group % scheme.length];
}
function redrawCountries(){
  if(!state.features.length || !path) return;

  const moneyVals = [...state.countries.values()].map(c=>c.money);
  const minM = Math.min(...moneyVals), maxM = Math.max(...moneyVals);

  const sel = g.selectAll('path.country').data(state.features, d=>d.properties.cid);
  const enter = sel.enter().append('path')
    .attr('class','country')
    .attr('d', path)
    .attr('stroke','#0b1025')
    .attr('stroke-width',0.5)
    .on('mouseenter', function(){ this.parentNode.appendChild(this); }) // raise on hover
    .on('click', (_e,d)=> selectCountry(d.properties.cid, true));

  g.selectAll('path.country').selectAll('title')
    .data(d => [d]).join('title').text(d => d.properties.name);

  sel.merge(enter).attr('fill', d => {
    const c = state.countries.get(d.properties.cid);
    if(state.colorMode==='happiness') return colorForH(overallHappiness(c||{regions:[]}));
    if(state.colorMode==='money') return colorForMoney((c?.money)||0, minM, maxM);
    if(state.colorMode==='alliances') return colorForAlliance(d.properties.cid);
    return '#ccc';
  });

  sel.exit().remove();
}

function drawAllianceLines(){
  allyLinesG.selectAll('*').remove();
  if(!state.showAllyLines) return;
  const lines = [...state.alliances].map(k=>{
    const [a,b]=k.split('|'); return {a, b, pa:countryCentroid(a), pb:countryCentroid(b)};
  });
  allyLinesG.selectAll('line').data(lines).enter().append('line')
    .attr('class','ally-line')
    .attr('x1',d=>d.pa[0]).attr('y1',d=>d.pa[1])
    .attr('x2',d=>d.pb[0]).attr('y2',d=>d.pb[1]);
}

/* =========================
   Tabs + Hotkeys
   ========================= */
const tabsEl = document.getElementById('tabs');
const TAB_ORDER = [
  'tab-overview','tab-regions','tab-projects','tab-economy',
  'tab-research','tab-diplomacy','tab-military','tab-log'
];
function setActiveTabById(id){
  [...tabsEl.querySelectorAll('.tabbtn')].forEach(b=>{
    b.classList.toggle('active', b.dataset.tab === id);
  });
  document.querySelectorAll('.tabpane').forEach(p=>{
    p.classList.toggle('active', p.id === id);
  });
}
function getActiveTabIndex(){
  const btn = tabsEl.querySelector('.tabbtn.active');
  const id = btn?.dataset.tab;
  return Math.max(0, TAB_ORDER.indexOf(id));
}
tabsEl?.addEventListener('click', (e)=>{
  const btn = e.target.closest('.tabbtn'); if(!btn) return;
  setActiveTabById(btn.dataset.tab);
});
document.addEventListener('keydown', (e)=>{
  const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
  if (e.altKey || e.ctrlKey || e.metaKey) return;
  if (tag === 'input' || tag === 'textarea' || tag === 'select' || e.target.isContentEditable) return;

  const n = parseInt(e.key, 10);
  if (!isNaN(n) && n >= 1 && n <= TAB_ORDER.length){
    e.preventDefault();
    setActiveTabById(TAB_ORDER[n-1]);
    return;
  }
  if (e.key === 'ArrowLeft' || e.key === 'ArrowRight'){
    e.preventDefault();
    const idx = getActiveTabIndex();
    const next = (e.key === 'ArrowRight')
      ? (idx + 1) % TAB_ORDER.length
      : (idx - 1 + TAB_ORDER.length) % TAB_ORDER.length;
    setActiveTabById(TAB_ORDER[next]);
  }
});

/* =========================
   Init world (map + names)
   ========================= */
async function loadNames() {
  const urls = [
    'https://cdn.jsdelivr.net/npm/world-atlas@2/country-names.tsv',
    'https://unpkg.com/world-atlas@2/country-names.tsv'
  ];
  for (const u of urls) {
    try {
      const r = await fetch(u, {cache:'force-cache'});
      if (!r.ok) continue;
      const rows = d3.tsvParse(await r.text());
      const map = new Map();
      rows.forEach(row=>{
        const idNum = +row.id;
        if(!isNaN(idNum)) map.set(idNum, row.name);
      });
      if(map.size) return map;
    } catch(_){}
  }
  return new Map();
}
async function initWorld(){
  sizeMap();

  const [topology, landTopo, lakesTopo, nameMap] = await Promise.all([
    fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json').then(r=>r.json()),
    fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/land-110m.json').then(r=>r.json()),
    fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/lakes-110m.json').then(r=>r.json()),
    loadNames()
  ]);

  state.features = topojson.feature(topology, topology.objects.countries).features.map(f=>{
    const idNum = +f.id;
    const name = nameMap.get(idNum) || f.properties?.name || `Country ${idNum}`;
    const cid = String(idNum);
    f.properties = { ...f.properties, name, cid };
    return f;
  });

  state.landFeature = topojson.feature(landTopo, landTopo.objects.land);
  state.lakesFeature = topojson.feature(lakesTopo, lakesTopo.objects.lakes);
  state.bordersMesh = topojson.mesh(topology, topology.objects.countries, (a,b)=>a!==b);

  // init countries
  state.countries.clear();
  const ids = [];
  for(const f of state.features){
    const id = f.properties.cid; ids.push(id);
    const name = f.properties.name;
    const rand = xorshift(+id * 2654435761);
    const regionsCount = 3 + Math.floor(rand()*6); // 3..8
    const weights = pickWeightedDirichlet(rand, regionsCount);
    const totalPop = 2_000_000 + Math.floor(rand()*60_000_000);
    const baseH = 40 + Math.floor(rand()*30);
    const regions = weights.map((w,i)=>{
      const res = RESOURCES[Math.floor(rand()*RESOURCES.length)];
      const prod = 5 + Math.floor(rand()*20);
      return {
        name: `${name} Region ${i+1}`,
        population: Math.max(50_000, Math.round(totalPop*w)),
        happiness: clamp(baseH + Math.floor(rand()*20-10), 10, 90),
        resource: res,
        production: prod,
        project: null,
        troops: 0
      };
    });
    state.countries.set(id, {
      id, name,
      money: 1200 + Math.floor(rand()*1500),
      military: 40 + Math.floor(rand()*80),
      government: 'democracy',
      regions,
      stock: { Food:0, Oil:0, Tech:0, Tourism:0 },
      isAI: true,
      buildings: [],
      // NEW systems
      budget: { welfare: 50 },                   // 0..100 (military = 100-welfare)
      conscription: 1,                           // 0 low, 1 med, 2 high
      researchDone: {},                          // id->true
      researchBuffs: { saleBonus:0, happyOverTime:0 } // dynamic buffs
    });
  }

  // neutral relations
  for(let i=0;i<ids.length;i++) for(let j=i+1;j<ids.length;j++) state.relations.set(`${ids[i]}|${ids[j]}`, 0);

  populateSelector();
  redrawCountries();
  updateLeaderboard();
  refreshMarket();
  drawAllianceLines();
  renderResearchList();
  log(`World ready: ${state.countries.size} countries.`);
}

/* =========================
   Overlay: Regions (Voronoi) & Buildings
   ========================= */
function clearRegionOverlay(){ if(state.regionOverlayG){ state.regionOverlayG.remove(); state.regionOverlayG=null; } d3.select('#clip-country').remove(); }

function buildRegionOverlay(countryId){
  clearRegionOverlay();
  const feature = state.features.find(f=> f.properties.cid===String(countryId));
  if(!feature) return;
  const c = state.countries.get(countryId); if(!c) return;

  const defs = svg.select('defs').empty() ? svg.append('defs') : svg.select('defs');
  const clip = defs.append('clipPath').attr('id','clip-country');
  clip.append('path').attr('d', path(feature));

  const rand = xorshift(+countryId * 1103515245);
  const bounds = d3.geoBounds(feature);
  const seeds=[]; let tries=0;
  while(seeds.length < c.regions.length && tries < 10000){
    tries++;
    const lon = bounds[0][0] + rand()*(bounds[1][0]-bounds[0][0]);
    const lat = bounds[0][1] + rand()*(bounds[1][1]-bounds[0][1]);
    if(d3.geoContains(feature, [lon,lat])){
      const p = projection([lon,lat]);
      if(p && isFinite(p[0]) && isFinite(p[1])) seeds.push(p);
    }
  }
  if(seeds.length===0){
    const cxy = projection(d3.geoCentroid(feature));
    if(cxy) seeds.push(cxy);
  }

  const D = d3.Delaunay.from(seeds);
  const V = D.voronoi([0,0,W,H]);

  state.regionOverlayG = g.append('g')
    .attr('class','regions-layer')
    .attr('clip-path','url(#clip-country)');

  // Region borders: back (dark halo) + front (light line)
  state.regionOverlayG.append('path')
    .attr('class','region-borders-back')
    .attr('d', V.render());

  state.regionOverlayG.append('path')
    .attr('class','region-borders-front')
    .attr('d', V.render());

  // Cells
  const cells = [];
  for(let i=0;i<seeds.length;i++){ const poly = V.cellPolygon(i); if(!poly) continue; cells.push(poly); }

  state.regionOverlayG.selectAll('path.region-cell')
    .data(cells.map((poly,idx)=>({poly, idx})))
    .enter().append('path')
    .attr('class','region-cell')
    .attr('d', d3.line()(d.poly))
    .attr('fill', d=> colorForH(c.regions[d.idx] ? c.regions[d.idx].happiness : overallHappiness(c)))
    .on('click', (_e,d)=>{
      state.selectedRegionIdx = d.idx; renderPanel();
    })
    .append('title')
    .text(d => {
      const r = c.regions[d.idx];
      return r ? `${r.name}\nRes: ${r.resource} (prod ${r.production}/t)\nPop: ${r.population.toLocaleString()}\nHappy: ${Math.round(r.happiness)}\nTroops: ${r.troops}`
               : 'Region';
    });

  drawBuildings();
  highlightSelectedRegionOnMap();
}

function highlightSelectedRegionOnMap(){
  if(!state.regionOverlayG) return;
  state.regionOverlayG.selectAll('path.region-cell')
    .classed('region-selected', (d)=> d.idx===state.selectedRegionIdx);
}

function clearBuildings(){ if(state.buildingsG){ state.buildingsG.remove(); state.buildingsG=null; } }
function drawBuildings(){
  clearBuildings();
  if(!state.selectedId || !state.regionOverlayG) return;
  const c = state.countries.get(state.selectedId);
  state.buildingsG = g.append('g').attr('class','buildings-layer').attr('clip-path','url(#clip-country)');
  const drag = d3.drag()
    .on('start', function(){ if(!state.movingBuildings) return; d3.select(this).raise(); })
    .on('drag', function(event){
      if(!state.movingBuildings) return;
      const b = d3.select(this).datum();
      b.x = event.x; b.y = event.y;
      d3.select(this).attr('transform', `translate(${b.x},${b.y})`);
    });

  const nodes = state.buildingsG.selectAll('g.building').data(c.buildings, (d,i)=>i);
  const enter = nodes.enter().append('g')
    .attr('class', d=>`building ${d.type}`)
    .attr('transform', d=>`translate(${d.x},${d.y})`)
    .call(drag);

  // sprites
  enter.each(function(d){
    const g = d3.select(this);
    if(d.type==='house'){
      g.append('polygon').attr('class','roof').attr('points','0,10 14,0 28,10');
      g.append('rect').attr('class','wall').attr('x',4).attr('y',10).attr('width',20).attr('height',14);
    } else if(d.type==='factory'){
      g.append('rect').attr('class','body').attr('x',0).attr('y',8).attr('width',30).attr('height',16);
      g.append('rect').attr('class','chimney').attr('x',6).attr('y',0).attr('width',6).attr('height',10);
      g.append('rect').attr('class','chimney').attr('x',18).attr('y',2).attr('width',6).attr('height',8);
    } else if(d.type==='hospital'){
      g.append('rect').attr('class','body').attr('x',2).attr('y',6).attr('width',28).attr('height',18);
      g.append('rect').attr('class','cross').attr('x',14).attr('y',2).attr('width',4).attr('height',16);
      g.append('rect').attr('class','cross').attr('x',10).attr('y',6).attr('width',12).attr('height',4);
    } else if(d.type==='school'){
      g.append('polygon').attr('class','roof').attr('points','0,8 15,0 30,8');
      g.append('rect').attr('class','body').attr('x',2).attr('y',8).attr('width',28).attr('height',16);
    } else if(d.type==='barracks'){
      g.append('polygon').attr('class','roof').attr('points','0,8 15,2 30,8');
      g.append('rect').attr('class','body').attr('x',2).attr('y',8).attr('width',28).attr('height',16);
    }
  });
}

/* =========================
   Conquered region overlays (visual annex)
   ========================= */
function drawAnnexOverlays(){
  let layer = g.select('g.annex-layer');
  if (layer.empty()) layer = g.append('g').attr('class','annex-layer');
  layer.selectAll('path').remove();
  if(!state.annexOverlays.length) return;
  layer.selectAll('path')
    .data(state.annexOverlays)
    .enter().append('path')
    .attr('d', d => d3.line()(d.polygon))
    .attr('fill', d => {
      const me = state.countries.get(d.ownerId);
      const h = me ? overallHappiness(me) : 70;
      const col = d3.color(colorForH(h));
      col.opacity = 0.35;
      return col;
    })
    .attr('stroke', '#ffd34d')
    .attr('stroke-width', 1.2)
    .append('title').text(d=>`Owned by ${d.ownerName}`);
}
// Deterministic Voronoi cells for a country (screen polys)
function computeRegionCells(countryId, regionCount){
  const feature = state.features.find(f=> f.properties.cid===String(countryId));
  if(!feature) return [];
  const bounds = d3.geoBounds(feature);
  const rand = xorshift(+countryId * 1103515245);
  const seeds=[]; let tries=0;
  while(seeds.length < regionCount && tries < 10000){
    tries++;
    const lon = bounds[0][0] + rand()*(bounds[1][0]-bounds[0][0]);
    const lat = bounds[0][1] + rand()*(bounds[1][1]-bounds[0][1]);
    if(d3.geoContains(feature, [lon,lat])){
      const p = projection([lon,lat]);
      if(p && isFinite(p[0]) && isFinite(p[1])) seeds.push(p);
    }
  }
  if(seeds.length===0){
    const cxy = projection(d3.geoCentroid(feature));
    if(cxy) seeds.push(cxy);
  }
  const D = d3.Delaunay.from(seeds);
  const V = D.voronoi([0,0,W,H]);
  const cells=[];
  for(let i=0;i<seeds.length;i++){
    const poly = V.cellPolygon(i);
    if(poly) cells.push(poly);
  }
  return cells;
}

/* =========================
   UI: selector + panel
   ========================= */
const countrySelect = document.getElementById('countrySelect');
function populateSelector(){
  countrySelect.innerHTML = '';
  const arr = [...state.countries.values()].sort((a,b)=> a.name.localeCompare(b.name));
  for(const c of arr){
    const opt = document.createElement('option');
    opt.value = String(c.id);
    opt.textContent = c.name;
    countrySelect.appendChild(opt);
  }
}

function selectCountry(id, zoom=false){
  state.selectedId = String(id);
  state.selectedRegionIdx = 0;
  const f = state.features.find(fe => fe.properties.cid === String(id));
  if (zoom && f) zoomToFeature(f, ()=> { buildRegionOverlay(id); });
  else buildRegionOverlay(id);
  renderPanel();
}

document.getElementById('startBtn').onclick = ()=>{
  const id = countrySelect.value || [...state.countries.keys()][0];
  state.playerId = String(id);
  state.countries.get(state.playerId).isAI = false;
  selectCountry(id, true);
  state.running = true;
  log(`You are playing as ${state.countries.get(state.playerId).name}. Maximize happiness!`);
  tick();
  renderPanel();
};

document.getElementById('colorMode').onchange = (e)=>{ state.colorMode = e.target.value; redrawCountries(); };
document.getElementById('showAllyLines').onchange = (e)=>{ state.showAllyLines = e.target.checked; drawAllianceLines(); };

/* =========================
   Zoom helpers
   ========================= */
function zoomToFeature(f, cb){
  const b = path.bounds(f);
  const dx = b[1][0]-b[0][0], dy=b[1][1]-b[0][1];
  const x = (b[0][0]+b[1][0])/2, y=(b[0][1]+b[1][1])/2;
  const scale = Math.max(1, Math.min(8, 0.9/Math.max(dx/W, dy/H)));
  const translate = [W/2 - scale*x, H/2 - scale*y];
  g.transition().duration(700).attr('transform', `translate(${translate}) scale(${scale})`).on('end', ()=> cb && cb());
}
document.getElementById('resetViewBtn').onclick = ()=>{
  g.transition().duration(600).attr('transform','translate(0,0) scale(1)');
  clearRegionOverlay(); clearBuildings();
};

function renderPanel(){
  const panel = document.getElementById('countryStats');
  const title = document.getElementById('panelTitle');
  if(!state.selectedId){ title.textContent = 'No country selected'; panel.style.display='none'; return; }
  const c = state.countries.get(state.selectedId);
  panel.style.display = 'block';
  title.textContent = c.name;
  document.getElementById('overallH').textContent = overallHappiness(c);
  document.getElementById('money').textContent = fmtMoney(c.money);
  document.getElementById('military').textContent = Math.round(c.military);
  document.getElementById('government').textContent = c.government;
  document.getElementById('playerTag').style.display = (String(c.id)===String(state.playerId)) ? '' : 'none';

  // regions list
  const list = document.getElementById('regions'); list.innerHTML='';
  c.regions.forEach((r,idx)=>{
    const row = document.createElement('div'); row.className='row';
    const sel = (idx===state.selectedRegionIdx) ? 'checked' : '';
    row.innerHTML = `
      <div style="flex:1 1 auto">
        <strong>${r.name}</strong><br/>
        <small>Pop: ${r.population.toLocaleString()} ‚Ä¢ Res: ${r.resource} ‚Ä¢ Prod: ${r.production}/t ‚Ä¢ Troops: ${r.troops} ‚Ä¢ Happy: <span id="rH${idx}">${Math.round(r.happiness)}</span></small>
      </div>
      <input type="radio" name="regionPick" value="${idx}" ${sel} />
      <input type="range" min="0" max="100" value="${Math.round(r.happiness)}" disabled />
    `;
    row.querySelector('input[type=radio]').addEventListener('change', ()=>{
      state.selectedRegionIdx = idx; highlightSelectedRegionOnMap(); renderProjects(); 
    });
    list.appendChild(row);
  });

  refreshMarket();
  renderResourceTotals(c);
  renderTradeUI();
  renderBudgetPolicyUI();
  renderResearchList();

  updateLeaderboard();
  redrawCountries();
  highlightSelectedRegionOnMap();
  renderProjects();
}

/* =========================
   Market / Resources
   ========================= */
function refreshMarket(){
  for(const k of RESOURCES){
    let p = state.market[k];
    const drift = (k==='Tech') ? 0.3 : (k==='Tourism'?0.2:0.15);
    p += (Math.random()-0.5)*2*drift;
    p = clamp(p, 2, 20);
    state.market[k] = Math.round(p*10)/10;
  }
  const mp = document.getElementById('marketPrices');
  mp.innerHTML = RESOURCES.map(r=>`<div class="stat"><strong>${r}</strong><br><small>$${state.market[r]}/unit</small></div>`).join('');
}
function renderResourceTotals(c){
  const div = document.getElementById('resourceTotals');
  div.innerHTML = RESOURCES.map(r=>`<div class="row"><strong>${r}</strong> <small>${Math.round(c.stock[r]||0)} units</small></div>`).join('');
}

/* =========================
   Budget & Conscription (Policies)
   ========================= */
function renderBudgetPolicyUI(){
  const me = state.countries.get(state.playerId); if(!me) return;
  const welfare = document.getElementById('budgetWelfare');
  const welfareVal = document.getElementById('budgetWelfareVal');
  welfare.value = me.budget.welfare; welfareVal.textContent = me.budget.welfare;
  welfare.oninput = ()=> welfareVal.textContent = welfare.value;
  document.getElementById('applyBudgetBtn').onclick = ()=>{
    me.budget.welfare = +welfare.value;
    const cons = document.getElementById('conscription');
    me.conscription = +cons.value;
    log(`Policies applied: Welfare ${me.budget.welfare}% ‚Ä¢ Conscription ${['Low','Medium','High'][me.conscription]}`);
  };
  const cons = document.getElementById('conscription');
  const consLbl = document.getElementById('conscriptionLabel');
  cons.value = me.conscription;
  consLbl.textContent = ['Low','Medium','High'][me.conscription];
  cons.oninput = ()=> consLbl.textContent = ['Low','Medium','High'][+cons.value];
}

/* =========================
   Research (one-time)
   ========================= */
function renderResearchList(){
  const me = state.countries.get(state.playerId); if(!me) return;
  const box = document.getElementById('researchList'); box.innerHTML='';
  RESEARCH.forEach(item=>{
    const done = !!me.researchDone[item.id];
    const row = document.createElement('div'); row.className='row';
    row.innerHTML = `<div><strong>${item.name}</strong><br/><small>${item.desc}</small></div>
      <div>${done?'<span class="pill">Unlocked</span>': `<button data-id="${item.id}">Unlock (${fmtMoney(item.cost)})</button>`}</div>`;
    box.appendChild(row);
  });
  box.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute('data-id');
      const item = RESEARCH.find(r=>r.id===id);
      const me = state.countries.get(state.playerId);
      if(me.money < item.cost){ log('<span class="danger">Not enough money.</span>'); return; }
      me.money -= item.cost; me.researchDone[id]=true; item.apply(me);
      log(`Research unlocked: <strong>${item.name}</strong>.`);
      renderPanel();
    };
  });
}

/* =========================
   Trade, Gifts, Diplomacy
   ========================= */
function renderTradeUI(){
  const sel = document.getElementById('partnerSelect'); sel.innerHTML='';
  [...state.countries.values()].filter(x=>String(x.id)!==String(state.playerId)).sort((a,b)=>a.name.localeCompare(b.name))
    .forEach(c=>{
      const o = document.createElement('option'); o.value=c.id; o.textContent=c.name; sel.appendChild(o);
    });
  updateRelationHint();
}
function updateRelationHint(){
  const partner = document.getElementById('partnerSelect').value;
  const rel = state.relations.get(keyPair(state.playerId, partner)) ?? 0;
  const allied = state.alliances.has(keyPair(state.playerId, partner));
  const atWar = state.wars.has(keyPair(state.playerId, partner));
  document.getElementById('relationHint').textContent = `Relation: ${rel} ${allied?'‚Ä¢ Allied':''} ${atWar?'‚Ä¢ At war':''}`;
}
document.getElementById('partnerSelect').addEventListener('change', updateRelationHint);

function bumpRelation(a,b,delta){ const k=keyPair(a,b); const v = state.relations.get(k) ?? 0; state.relations.set(k, clamp(v+delta, -100, 100)); updateRelationHint(); }
function aiAcceptsTrade(sellerId, buyerId, res, amount, pricePerUnit){
  const buyer = state.countries.get(buyerId);
  const rel = state.relations.get(keyPair(sellerId, buyerId)) ?? 0;
  const need = Math.max(0, 100 - (buyer.stock[res]||0));
  const willingPrice = state.market[res] * (1 + (rel/300)) + (need/500);
  return pricePerUnit <= willingPrice;
}
document.getElementById('sellBtn').onclick = ()=>{
  const me = state.countries.get(state.playerId);
  const partnerId = document.getElementById('partnerSelect').value;
  const res = document.getElementById('tradeResource').value;
  const amt = Math.max(1, +document.getElementById('tradeAmount').value || 1);
  if((me.stock[res]||0) < amt){ log('<span class="danger">You lack enough stock.</span>'); return; }
  const price = state.market[res] * (state.alliances.has(keyPair(state.playerId, partnerId)) ? 1.1 : 1.0) * (1 + (state.countries.get(state.playerId).researchBuffs.saleBonus||0));
  if(!aiAcceptsTrade(state.playerId, partnerId, res, amt, price)){ log(`<span class="danger">${state.countries.get(partnerId).name} declined your offer.</span>`); return; }
  me.stock[res]-=amt; me.money += price*amt;
  const partner = state.countries.get(partnerId); partner.stock[res]=(partner.stock[res]||0)+amt; partner.money -= price*amt;
  bumpRelation(state.playerId, partnerId, +3);
  log(`Sold ${amt} ${res} to ${partner.name} for ${fmtMoney(price*amt)}.`);
  renderPanel();
};
document.getElementById('buyBtn').onclick = ()=>{
  const me = state.countries.get(state.playerId);
  const partnerId = document.getElementById('partnerSelect').value;
  const res = document.getElementById('tradeResource').value;
  const amt = Math.max(1, +document.getElementById('tradeAmount').value || 1);
  const partner = state.countries.get(partnerId);
  if((partner.stock[res]||0) < amt){ log('<span class="danger">Partner lacks stock.</span>'); return; }
  const price = state.market[res] * (state.alliances.has(keyPair(state.playerId, partnerId)) ? 0.9 : 1.0);
  const cost = price*amt; if(me.money < cost){ log('<span class="danger">You lack funds.</span>'); return; }
  if(!aiAcceptsTrade(partnerId, state.playerId, res, amt, price)){ log(`<span class="danger">${partner.name} declined to sell.</span>`); return; }
  partner.stock[res]-=amt; partner.money += cost;
  me.stock[res]=(me.stock[res]||0)+amt; me.money -= cost;
  bumpRelation(state.playerId, partnerId, +3);
  log(`Bought ${amt} ${res} from ${partner.name} for ${fmtMoney(cost)}.`);
  renderPanel();
};
document.getElementById('allyBtn').onclick = ()=>{
  const me = state.countries.get(state.playerId);
  const partnerId = document.getElementById('partnerSelect').value;
  const k = keyPair(me.id, partnerId);
  const rel = state.relations.get(k) ?? 0;
  if(state.alliances.has(k)){ log('Already allies.'); return; }
  if(state.wars.has(k)){ log('<span class="danger">Can‚Äôt ally while at war.</span>'); return; }
  const acceptChance = 0.5 + (rel/200) + (Math.random()*0.2-0.1);
  if(Math.random() < acceptChance){
    state.alliances.add(k);
    adjustAllRegions(me, +2); adjustAllRegions(state.countries.get(partnerId), +2);
    bumpRelation(me.id, partnerId, +15);
    log(`Alliance formed with ${state.countries.get(partnerId).name}! (+2 happiness both)`);
    drawAllianceLines(); redrawCountries();
  }else{
    bumpRelation(me.id, partnerId, -5);
    log(`<span class="danger">${state.countries.get(partnerId).name} refused your alliance.</span>`);
  }
};
document.getElementById('giftMoneyBtn').onclick = ()=>{
  const me = state.countries.get(state.playerId);
  const partnerId = document.getElementById('partnerSelect').value;
  if(me.money < 500){ log('<span class="danger">Not enough money.</span>'); return; }
  me.money -= 500; state.countries.get(partnerId).money += 500;
  bumpRelation(me.id, partnerId, +8);
  log(`You sent ${fmtMoney(500)} to ${state.countries.get(partnerId).name}. Relations improved.`);
  renderPanel();
};
document.getElementById('giftResBtn').onclick = ()=>{
  const me = state.countries.get(state.playerId);
  const partnerId = document.getElementById('partnerSelect').value;
  const res = document.getElementById('tradeResource').value;
  if((me.stock[res]||0) < 20){ log('<span class="danger">You lack resource units.</span>'); return; }
  me.stock[res]-=20; state.countries.get(partnerId).stock[res]=(state.countries.get(partnerId).stock[res]||0)+20;
  bumpRelation(me.id, partnerId, +6);
  log(`You sent 20 ${res} to ${state.countries.get(partnerId).name}. Relations improved.`);
  renderPanel();
};

/* =========================
   Military / War
   ========================= */
function adjustAllRegions(country, delta){ country.regions.forEach(r=> r.happiness = clamp(r.happiness + delta, 0, 100)); }
document.getElementById('declareWarBtn').onclick = ()=>{
  const enemyId = document.getElementById('partnerSelect').value;
  const k = keyPair(state.playerId, enemyId);
  if(state.wars.has(k)){ log('War already active.'); return; }
  state.wars.add(k);
  bumpRelation(state.playerId, enemyId, -25);
  state.alliances.delete(k);
  log(`<span class="danger">You declared war on ${state.countries.get(enemyId).name}!</span>`);
  redrawCountries();
};
document.getElementById('peaceBtn').onclick = ()=>{
  const enemyId = document.getElementById('partnerSelect').value;
  const k = keyPair(state.playerId, enemyId);
  if(!state.wars.has(k)){ log('You are not at war.'); return; }
  if(Math.random()<0.6){ state.wars.delete(k); bumpRelation(state.playerId, enemyId, +10); log(`Peace signed with ${state.countries.get(enemyId).name}.`); }
  else { log(`<span class="danger">${state.countries.get(enemyId).name} refused peace.</span>`); bumpRelation(state.playerId, enemyId, -3); }
};
document.getElementById('attackBtn').onclick = ()=>{
  const enemyId = document.getElementById('partnerSelect').value;
  const k = keyPair(state.playerId, enemyId);
  if(!state.wars.has(k)){ log('<span class="danger">You must be at war to attack.</span>'); return; }
  const me = state.countries.get(state.playerId);
  const enemy = state.countries.get(enemyId);
  if(!enemy.regions.length){ log('Enemy has no regions left.'); return; }
  const eIdx = enemy.regions.reduce((bi,_,i,arr)=> arr[i].happiness < arr[bi].happiness ? i : bi, 0);
  const myRegion = me.regions[state.selectedRegionIdx];
  const myPower = myRegion.troops + Math.min(10, Math.floor(me.military*0.3));
  const enemyPower = enemy.regions[eIdx].troops + Math.min(10, Math.floor(enemy.military*0.25));
  if(myPower <= 0){ log('<span class="danger">No troops in the selected region.</span>'); return; }
  const roll = (myPower + (Math.random()*6)) - (enemyPower + (Math.random()*6));
  if(roll > 0){
    // Snapshot conquered polygon BEFORE removing region
    const enemyCells = computeRegionCells(enemyId, enemy.regions.length);
    const conqueredPoly = enemyCells[eIdx] || null;

    const taken = enemy.regions.splice(eIdx,1)[0];
    taken.happiness = clamp(taken.happiness - 10, 0, 100);
    const newTroops = Math.max(1, Math.floor(myPower*0.5));
    taken.troops = newTroops;
    me.regions.push(taken);
    myRegion.troops = Math.max(0, myRegion.troops - newTroops);
    enemy.military = Math.max(0, enemy.military - 5);
    me.military = Math.max(0, me.military - 3);
    adjustAllRegions(enemy, -2);

    // Visual annex overlay
    if(conqueredPoly){
      state.annexOverlays.push({ ownerId: state.playerId, ownerName: me.name, polygon: conqueredPoly });
      drawAnnexOverlays();
    }

    log(`<strong>Victory!</strong> You captured ${taken.name} from ${enemy.name}.`);
  }else{
    myRegion.troops = Math.max(0, myRegion.troops - Math.ceil(enemyPower*0.5));
    me.military = Math.max(0, me.military - 4);
    adjustAllRegions(me, -1);
    log(`<span class="danger">Attack failed against ${enemy.name}.</span>`);
  }
  renderPanel(); buildRegionOverlay(state.selectedId);
};
document.getElementById('assignTroopsBtn').onclick = ()=>{
  const me = state.countries.get(state.playerId);
  const d = Math.max(0, +document.getElementById('troopDelta').value||0);
  if(d<=0) return;
  if(me.military < d){ log('<span class="danger">Not enough units in pool.</span>'); return; }
  me.military -= d; me.regions[state.selectedRegionIdx].troops += d;
  log(`Assigned ${d} troops to ${me.regions[state.selectedRegionIdx].name}.`);
  renderPanel(); buildRegionOverlay(state.playerId);
};
document.getElementById('removeTroopsBtn').onclick = ()=>{
  const me = state.countries.get(state.playerId);
  const d = Math.max(0, +document.getElementById('troopDelta').value||0);
  const r = me.regions[state.selectedRegionIdx];
  if(d<=0) return;
  if(r.troops < d){ log('<span class="danger">Region lacks that many troops.</span>'); return; }
  r.troops -= d; me.military += d;
  log(`Removed ${d} troops from ${r.name}.`);
  renderPanel(); buildRegionOverlay(state.playerId);
};

/* =========================
   Projects & Buildings placement
   ========================= */
function renderProjects(){
  const c = state.countries.get(state.selectedId); if(!c) return;
  const idx = state.selectedRegionIdx || 0;
  const r = c.regions[idx];
  const list = document.getElementById('projectList'); list.innerHTML='';
  if(r.project){
    list.innerHTML = `<div class="row"><strong>${r.project.desc}</strong><small>${r.project.durationLeft} turns left</small></div>`;
  }else{
    list.innerHTML = `<div class="row"><small>No active project in ${r.name}.</small></div>`;
  }
}
document.getElementById('startProjectBtn').onclick = ()=>{
  const me = state.countries.get(state.playerId); if(!me) return;
  const idx = state.selectedRegionIdx || 0;
  const r = me.regions[idx];
  if(r.project){ log('<span class="danger">A project is already active.</span>'); return; }
  if(me.money < 250){ log('<span class="danger">Not enough money.</span>'); return; }
  const type = document.getElementById('projectSelect').value;
  me.money -= 250;
  if(type==='infra'){ r.project = {type, durationLeft:4, desc:`Infrastructure in ${r.name} (+2 happiness/turn)`}; }
  if(type==='upgrade'){ r.project = {type, durationLeft:3, desc:`Resource upgrade in ${r.name} (+20% production)`}; }
  if(type==='culture'){ r.project = {type, durationLeft:2, desc:`Cultural program in ${r.name} (+8 happiness once)`}; }
  log(`Started project: ${r.project.desc}`);
  renderPanel();
};
document.getElementById('placeBuildingBtn').onclick = ()=>{
  const me = state.countries.get(state.playerId); if(!me) return;
  const type = document.getElementById('buildSelect').value;
  const costMap = {house:200, factory:400, hospital:450, school:350, barracks:300};
  const cost = costMap[type]||200;
  if(me.money < cost){ log('<span class="danger">Not enough money.</span>'); return; }
  me.money -= cost;
  state.placingBuilding = {type};
  log(`Placing ${type}. Click inside your country to drop it.`);
  state.regionOverlayG.on('click.place', (ev)=>{
    if(!state.placingBuilding) return;
    const [x,y] = d3.pointer(ev, g.node());
    const idx = state.selectedRegionIdx;
    me.buildings.push({type: state.placingBuilding.type, x, y, regionIdx: idx});
    // building effects
    const r = me.regions[idx];
    if(type==='hospital') r.happiness = clamp(r.happiness + 4, 0, 100);
    if(type==='school') r.production += 1;
    if(type==='barracks') r.troops += 2;
    if(type==='factory'){ me.money += 25; r.happiness = clamp(r.happiness - 1, 0, 100); }
    if(type==='house'){ r.population += 800; }
    state.placingBuilding = null;
    log(`Building placed and effects applied.`);
    state.regionOverlayG.on('click.place', null);
    drawBuildings(); renderPanel();
  });
};
document.getElementById('moveBuildingsToggle').onchange = (e)=>{
  state.movingBuildings = e.target.checked;
  drawBuildings();
};

/* =========================
   Player actions (overview)
   ========================= */
document.getElementById('developAllBtn').onclick = ()=>{
  const me = state.countries.get(state.playerId); if(!me) return;
  if(me.money < 400){ log('<span class="danger">Not enough money.</span>'); return; }
  me.money -= 400; adjustAllRegions(me, +2);
  log('Nationwide development: +2 happiness in every region.');
  renderPanel(); buildRegionOverlay(state.playerId);
};
document.getElementById('govSelect').onchange = (e)=>{
  const me = state.countries.get(state.playerId); if(!me) return;
  const g = e.target.value; if(!g) return;
  me.government = g;
  const boost = g==='democracy'?5 : g==='socialism'?3 : 1;
  adjustAllRegions(me, +boost);
  log(`Government changed to <b>${g}</b>. +${boost} happiness in all regions.`);
  e.target.value='';
  renderPanel(); buildRegionOverlay(state.playerId);
};

/* =========================
   Turn loop: production, projects, policy effects, events, AI
   ========================= */
function playerProductionAndProjects(){
  const me = state.countries.get(state.playerId); if(!me) return;
  // production
  for(const r of me.regions){
    const eff = r.project && r.project.type==='upgrade' ? 1.2 : 1.0;
    me.stock[r.resource] += r.production * eff;
  }
  // projects
  for(const r of me.regions){
    if(r.project){
      if(r.project.type==='infra'){ r.happiness = clamp(r.happiness + 2, 0, 100); }
      if(r.project.type==='culture' && r.project.durationLeft===2){ r.happiness = clamp(r.happiness + 8, 0, 100); }
      r.project.durationLeft -= 1;
      if(r.project.durationLeft<=0) r.project=null;
    }
  }
  // budget effects
  const w = me.budget.welfare/100, m = 1-w;
  me.money += Math.round(40*m); // military budget yields some income via industry
  me.regions.forEach(r=>{ r.happiness = clamp(r.happiness + (w*1.5), 0, 100); });
  // conscription
  const cons = me.conscription; // 0/1/2
  const troopGain = cons===0? 1 : cons===1? 3 : 6;
  me.military += troopGain;
  adjustAllRegions(me, -(cons===2?2:cons===1?1:0)); // high conscription hurts happiness
  // research timed buff
  if(me.researchBuffs.happyOverTime>0){
    me.regions.forEach(r=> r.happiness = clamp(r.happiness + 2, 0, 100));
    me.researchBuffs.happyOverTime -= 1;
  }
}
function aiTurnOne(c){
  // produce
  for(const r of c.regions){
    const eff = r.project && r.project.type==='upgrade' ? 1.2 : 1.0;
    c.stock[r.resource] += r.production * eff;
  }
  // projects
  for(const r of c.regions){
    if(r.project){
      if(r.project.type==='infra'){ r.happiness = clamp(r.happiness + 2, 0, 100); }
      if(r.project.type==='culture' && r.project.durationLeft===2){ r.happiness = clamp(r.happiness + 8, 0, 100); }
      r.project.durationLeft -= 1;
      if(r.project.durationLeft<=0) r.project=null;
    }
  }
  // simple AI policy drift & actions
  c.money += 80;
  if(Math.random()<0.2){ c.conscription = clamp((c.conscription + (Math.random()<0.5?-1:1)),0,2); }
  if(Math.random()<0.2){ c.budget.welfare = clamp(c.budget.welfare + (Math.random()<0.5?-10:10),0,100); }
  const worst = [...c.regions].sort((a,b)=> a.happiness - b.happiness)[0];
  if(c.money >= 200 && worst.happiness < 80){ c.money -= 200; worst.happiness = clamp(worst.happiness + 5, 0, 100); return `${c.name} invested in ${worst.name} (+5).`; }
  if(Math.random()<0.12){ const opts=['democracy','socialism','communism']; const g = opts[Math.floor(Math.random()*opts.length)];
    c.government=g; const boost=g==='democracy'?4:g==='socialism'?3:1; c.regions.forEach(r=>r.happiness=clamp(r.happiness+boost,0,100)); return `${c.name} changed government to ${g} (+${boost}).`; }
  if(c.money>=150 && Math.random()<0.16){ c.money-=150; c.military+=3; c.regions.forEach(r=>r.happiness=clamp(r.happiness-1,0,100)); return `${c.name} bought military (-1).`; }
  if(Math.random()<0.25){
    const res=RESOURCES[Math.floor(Math.random()*RESOURCES.length)];
    const amt = Math.min(30, c.stock[res]||0);
    if(amt>0){ c.stock[res]-=amt; c.money += amt*state.market[res]; return `${c.name} sold ${amt} ${res}.`; }
  }
  return `${c.name} maintained stability.`;
}
function maybeEvent(){
  state.turn++;
  const banner = document.getElementById('eventBanner');
  banner.style.display='none';
  if(state.turn % 3 !== 0) return;
  const roll = Math.random();
  let msg='';
  if(roll < 0.25){
    const boom = Math.random()<0.5;
    for(const c of state.countries.values()){
      if(boom){ c.money += 200; adjustAllRegions(c, +1); }
      else { c.money = Math.max(0, c.money - 150); adjustAllRegions(c, -1); }
    }
    msg = boom ? 'Global Economic Boom! +$200 and +1 happiness everywhere.' :
                 'Global Recession. -$150 and -1 happiness everywhere.';
  } else if(roll < 0.6){
    const keys=[...state.countries.keys()];
    const victimId = keys[Math.floor(Math.random()*keys.length)];
    const v = state.countries.get(victimId);
    if(v.regions.length){
      const idx = Math.floor(Math.random()*v.regions.length);
      const r = v.regions[idx];
      r.happiness = clamp(r.happiness - 12, 0, 100);
      r.population = Math.max(1000, Math.round(r.population*0.98));
      msg = `Disaster in ${r.name}! -12 happiness, -2% population.`;
    }
  } else {
    if(state.alliances.size>0){
      const any = [...state.alliances][Math.floor(Math.random()*state.alliances.size)].split('|');
      const a = state.countries.get(any[0]), b = state.countries.get(any[1]);
      adjustAllRegions(a, +3); adjustAllRegions(b, +3);
      msg = `Alliance Cultural Festival in ${a.name} & ${b.name}! +3 happiness in both.`;
    } else {
      const keys=[...state.countries.keys()];
      const id = keys[Math.floor(Math.random()*keys.length)];
      const c = state.countries.get(id);
      adjustAllRegions(c, +4);
      msg = `World Expo hosted by ${c.name}! +4 happiness nationwide.`;
    }
  }
  banner.textContent = 'Event: ' + msg;
  banner.style.display = 'block';
  log(`<strong>Event:</strong> ${msg}`);
}
function aiIntertrade(){
  const ids = [...state.countries.keys()];
  if(ids.length<2) return;
  const a = state.countries.get(ids[Math.floor(Math.random()*ids.length)]);
  const b = state.countries.get(ids[Math.floor(Math.random()*ids.length)]);
  if(a.id===b.id) return;
  const res = RESOURCES[Math.floor(Math.random()*RESOURCES.length)];
  const amt = Math.min(20, a.stock[res]||0);
  if(amt<=0) return;
  const price = state.market[res];
  a.stock[res]-=amt; a.money += amt*price;
  b.stock[res]=(b.stock[res]||0)+amt; b.money -= amt*price;
  bumpRelation(a.id, b.id, +2);
}
function tick(){
  if(!state.running) return;
  playerProductionAndProjects();
  for(const c of state.countries.values()){
    if(String(c.id)!==String(state.playerId)){
      const msg = aiTurnOne(c);
      if(Math.random()<0.25) log(msg);
    }
  }
  refreshMarket();
  maybeEvent();
  if(Math.random()<0.25) aiIntertrade();

  redrawCountries();
  drawAnnexOverlays();
  updateLeaderboard();
  renderPanel();
  if(state.selectedId){ buildRegionOverlay(state.selectedId); }

  setTimeout(tick, state.tickMs);
}

/* =========================
   Save / Load (slots)
   ========================= */
const slotSel = document.getElementById('saveSlot');
function currentKey(){ return STORAGE_KEY_BASE + (slotSel.value || '1'); }
document.getElementById('saveBtn').onclick = ()=>{
  const payload = {
    version: 7,
    playerId: state.playerId,
    selectedId: state.selectedId,
    selectedRegionIdx: state.selectedRegionIdx,
    turn: state.turn,
    market: state.market,
    alliances: [...state.alliances],
    wars: [...state.wars],
    relations: [...state.relations.entries()],
    annexOverlays: state.annexOverlays,
    data: [...state.countries.entries()].map(([id,c])=>[String(id),{
      id:String(c.id), name:c.name, money:c.money, military:c.military, government:c.government, isAI:c.isAI,
      stock:c.stock, buildings:c.buildings,
      budget:c.budget, conscription:c.conscription, researchDone:c.researchDone, researchBuffs:c.researchBuffs,
      regions: c.regions.map(r=>({name:r.name, population:r.population, happiness:r.happiness, resource:r.resource, production:r.production, project:r.project, troops:r.troops}))
    }])
  };
  localStorage.setItem(currentKey(), JSON.stringify(payload));
  log(`Saved to slot ${slotSel.value}.`);
};
document.getElementById('loadBtn').onclick = ()=>{
  const raw = localStorage.getItem(currentKey());
  if(!raw){ log('<span class="danger">No save in this slot.</span>'); return; }
  try{
    const payload = JSON.parse(raw);
    state.playerId = payload.playerId ? String(payload.playerId) : null;
    state.selectedId = payload.selectedId ? String(payload.selectedId) : null;
    state.selectedRegionIdx = payload.selectedRegionIdx || 0;
    state.turn = payload.turn || 0;
    state.market = payload.market || state.market;
    state.alliances = new Set(payload.alliances || []);
    state.wars = new Set(payload.wars || []);
    state.relations = new Map(payload.relations || []);
    state.annexOverlays = payload.annexOverlays || [];
    state.countries.clear();
    for(const [id,c] of payload.data){ state.countries.set(String(id), c); }
    populateSelector();
    state.running = true;
    const selectId = state.selectedId || state.playerId || [...state.countries.keys()][0];
    selectCountry(selectId, true);
    updateLeaderboard(); refreshMarket(); drawAllianceLines(); renderResearchList(); drawAnnexOverlays();
    log(`Loaded from slot ${slotSel.value}.`);
  }catch(e){ console.error(e); log('<span class="danger">Failed to load save.</span>'); }
};

/* =========================
   Leaderboard + logging
   ========================= */
function updateLeaderboard(){
  const holder = document.getElementById('leaderboard');
  const arr = [...state.countries.values()].map(c=>({ id:c.id, name:c.name, h:overallHappiness(c) }));
  arr.sort((a,b)=> b.h - a.h);
  holder.innerHTML = arr.slice(0,6).map((c,i)=>`
    <div class="stat">${i+1}. <strong>${c.name}</strong> ‚Äî <span class="leader">${c.h}</span>
      ${String(c.id)===String(state.playerId)?' <span class="pill">You</span>':''}
    </div>`).join('');
}
function log(html){
  const el = document.getElementById('log');
  const p = document.createElement('div');
  p.innerHTML = `<span class="muted">${new Date().toLocaleTimeString()}</span> ${html}`;
  el.appendChild(p);
  el.scrollTop = el.scrollHeight;
}

/* =========================
   Kick off
   ========================= */
initWorld().catch(err=>{
  console.error(err);
  log('<span class="danger">Failed to load world map. Check your network/CSP.</span>');
});
</script>
</body>
</html>
